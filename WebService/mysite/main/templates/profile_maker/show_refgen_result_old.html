<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.js"></script>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.1/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
    <script>
    $(document).ready(function() {
       var table = $('#test').DataTable( {
          select: {
              style:    'single',
          },
          order: [[ 1, 'asc' ]],

          //dom: 'Bfrtip',
          //buttons: [
          //  {extend: 'csvHtml5', charset: 'UTF-8', exportOptions: {orthogonal : 'export'}}
          //],
          'scrollX':true,
          'ajax':{url: {{target_url|safe}}, uuid: {{uuid|safe}}}
       } );

       table.on('user-select', function (e, dt, type, cell, originalEvent) {
          //if (originalEvent.target.nodeName.toLowerCase() === '') {
          //e.preventDefault();
          // }
       });

       document.getElementById('back_sample_selection').addEventListener('click', back_sample_selection);
       function back_sample_selection(){
           var form = document.getElementById('form_process_data');
           var target_url = form.action.replace('show_refgen','show');
           window.location.replace(target_url);
       }



       document.getElementById('process_data').addEventListener('click', process_data);
       function process_data(){
           var form = document.getElementById('form_process_data');
           var row_data = table.rows({selected : true}).data();
           if (row_data.length == 0){
               alert('Please select at least one reference genome for data processing!');
               return;
           }
           var cor_file=document.getElementById('upload_corr_file').files.item(0);
           if (cor_file === null){
               alert('File for correlation validation is missing!');
               return;
           }
           var knowledge_capture_sample_file=document.getElementById('upload_knowledge_capture_sample_file').files.item(0);
           if (knowledge_capture_sample_file === null){
               alert('File for knowledge capture validation (sample) is missing!');
               return;
           }
           var knowledge_capture_gene_file=document.getElementById('upload_knowledge_capture_gene_file').files.item(0);
           if (knowledge_capture_gene_file === null){
               alert('File for knowledge capture validation (gene) is missing!');
               return;
           }
           var email=document.getElementById('email');
           var gff_url=row_data[0][3];

           console.log(email.value);

           var xhr = new XMLHttpRequest();
        
           // file received/failed
           xhr.onload = function(e) {
                if (xhr.readyState == 4) {
                     if (xhr.status == 200){
                         alert('success');
                         window.location.replace('/submitted');
                     }else{
                         alert('error: Invalid format!');
                     }
                }else{
                     setTimeout(function(){},1000);
                }
           }

           var target_url = form.action;
           console.log(target_url);
           //return;        
           // start upload
           xhr.open(form.method, target_url, true);

           //Prepare form data
           var formData = new FormData();
           formData.append('cor_file',cor_file, cor_file.name);
           formData.append('knowledge_capture_sample_file',knowledge_capture_sample_file, knowledge_capture_sample_file.name);
           formData.append('knowledge_capture_gene_file',knowledge_capture_gene_file, knowledge_capture_gene_file.name);
           formData.append('email', email.value);
           formData.append('gff_url', gff_url);
           xhr.send(formData);
           return;
           /*
           console.log(row_data[0][3]);
           var loader = document.getElementById("loader");
           loader.style.display = "block";
           var cur_button = document.getElementById("process_data");
           cur_button.disabled = true;
           */



       }

    } );
   
    </script>
</head>

<style>
/* Center the loader */
#loader {
  position: absolute;
  left: 50%;
  top: 50%;
  z-index: 1;
  width: 150px;
  height: 150px;
  margin: -75px 0 0 -75px;
  border: 16px solid #f3f3f3;
  border-radius: 50%;
  border-top: 16px solid #3498db;
  width: 120px;
  height: 120px;
  -webkit-animation: spin 2s linear infinite;
  animation: spin 2s linear infinite;
}

@-webkit-keyframes spin {
  0% { -webkit-transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Add animation to "page content" */
.animate-bottom {
  position: relative;
  -webkit-animation-name: animatebottom;
  -webkit-animation-duration: 1s;
  animation-name: animatebottom;
  animation-duration: 1s
}

@-webkit-keyframes animatebottom {
  from { bottom:-100px; opacity:0 } 
  to { bottom:0px; opacity:1 }
}

@keyframes animatebottom { 
  from{ bottom:-100px; opacity:0 } 
  to{ bottom:0; opacity:1 }
}

#myDiv {
  display: none;
  text-align: center;
}
</style>







<CENTER>
<div class="jumbotron">
  <h2 class="display-4">Available reference genome selection<br></h2>
  <p class="lead"></p>
  <hr class="my-4">
  <p>
  </p>
  <form id="refgen_table" method="post">
     <table id='test' class="display nowrap" style="width:100%">
       {{table_header|safe}}
     </table>
  
  </form>
  <form id="form_process_data" method="post">
  <table>
    <tr>
      <td>Correlation Validation File:</td>
      <td><input type="file" id="upload_corr_file" accept=".csv"></td>
    </tr>
    <tr>
      <td>Knowledge Capture Validation Sample File:</td>
      <td><input type="file" id="upload_knowledge_capture_sample_file" accept=".csv"></td>
    </tr>
    <tr>
      <td>Knowledge Capture Validation Gene File:</td>
      <td><input type="file" id="upload_knowledge_capture_gene_file" accept=".csv"></td>
    </tr>
    <tr>
      <td>Email:</td>
      <td><input type="email" id="email"></td>
    </tr> 
    <tr> 
      <td><input class="Column" type="button" id="back_sample_selection" value='<< Sample Selection'></td>
      <td><input class="Column" type="button" id="process_data" value='Process Data >>'></td>
    </tr>
    
  </table>
  </form>
  <div id="loader" style="display:none"></div>
 </div>
</CENTER>

