<!DOCTYPE html>
<html>
    <head>
        <title>Pipeline Testing!</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    </head>
    <body>
        <center>
            <div class="jumbotron">
                <h2 class="display-4"><font size="6">Automatic transcriptomic compendium pipeline webservice version (Testing)</font></h2>
                        {% block replace %}
                <p class="lead">Please provide all necessary information</p>
                <hr class="my-4">
                <div id = "usage" align='left'>
                    <h3> How to use it </h3>
                    <ol>
                    <font size="4"><li> Fill the topic you are interested in (example: "Salmonella", "stroke")
                        <br> <b>NOTE: For the test version, the pipeline will use the experiments in optional experiment filter file and overwrite all query results.</b>
                    </li>
                    <li> Fill the species you are interested in (example: "Salmonella enterica", "Homo sapiens") </li>
                    </font>
                    </ol>
                </div>
                <!-- <form method="POST" enctype="multipart/form-data" id="query_form"> -->
                    <form method="POST" enctype="multipart/form-data" id="query_form">
                    <!-- Very Important csrf Token -->
                    {% csrf_token %}
                    <table>
                        {{ form.as_table }}
                    </table>
                    <input type="button" class="btn btn-primary btn-lg" name="register" value="Submit" id="submit_form" onclick="myFunction()">
                    </form>

                    <div class="container">
                      <br>
                      <div class="progress">
                        <div class="progress-bar" role="progressbar" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100" style="width:0%" id='progress_bar'>
                        </div>
                      </div>
                    </div>
            </div>
        </center>
        {% endblock %}
    </body>
</html>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script>

// Generate 32 char random uuid 
function gen_uuid() {
    var uuid = ""
    for (var i=0; i < 32; i++) {
        uuid += Math.floor(Math.random() * 16).toString(16); 
    }
    return uuid
}

function sleep(milliseconds) {
  const date = Date.now();
  let currentDate = null;
  do {
    currentDate = Date.now();
  } while (currentDate - date < milliseconds);
}

async function myFunction(){
    alert("The Form was submitted");
    document.getElementById("submit_form").disabled = true;
    var query_form = document.getElementById("query_form");
    var progress_bar = document.getElementById("progress_bar");

    var freq = 1000; // freqency of update in ms
    var uuid = gen_uuid(); // id for this upload so we can fetch progress info.
    var progress_url = 'query_progress/'; // ajax view serving progress info
   
    var i = 0;
    
    progress_bar.style.width="0%";
    progress_bar.innerHTML="0%";

    var target_url = 'submit?studies=' + query_form.studies.value 
                                 + "&species=" + query_form.species.value
                                 + "&uuid=" + uuid;


    var show_url = 'show?studies=' + query_form.studies.value 
                                 + "&species=" + query_form.species.value
                                 + "&uuid=" + uuid;


    var request = new XMLHttpRequest();
    (function loop(i, length) {
        if (false) {
            return;
        }

        request.open("GET", target_url);
        request.onreadystatechange = function() {
            if(request.readyState === XMLHttpRequest.DONE && request.status === 200) {
                var data = JSON.parse(request.responseText);
                console.log(data);
                if (data.cur_progress == -1){
                    alert('error occured');
                    window.location.replace('');
                }
                console.log(Math.round(data.cur_progress*100));
                console.log(Math.round(data.cur_progress*100) == 100);
                progress_bar.style.width = Math.round(data.cur_progress*100) + "%";
                progress_bar.innerHTML = Math.round(data.cur_progress*100)  + "%";
                if (Math.round(data.cur_progress*100) == 100){
                    //The result is ready. Show it :)
                    window.location.replace(show_url);
                    return;
                }
                loop(i + 1, length);
            }
        }
        request.send();
    })(0, 10);

    return;


}
</script>
